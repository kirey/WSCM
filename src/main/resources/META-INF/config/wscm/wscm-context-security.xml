<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:jpa="http://www.springframework.org/schema/data/jpa"
	xmlns:security="http://www.springframework.org/schema/security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd       
        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa-4.2.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.0.xsd">

	<!-- SPRING SECURITY SETUP -->
	
 	<!-- Authentication manager -->
	<security:authentication-manager id="authenticationManager">
		<security:authentication-provider user-service-ref="kjcUserAccountsDao">
			<security:password-encoder ref="encoder" hash="bcrypt" />
		</security:authentication-provider>
	</security:authentication-manager>
	
		
	<!-- Disable security -->	
	<security:http security="none" pattern="/app/**"/>
    <security:http security="none" pattern="/node_modules/**"/>
    
	<!-- HTTP settings -->
	<security:http 	realm="Protected API" 
					use-expressions="true"
					auto-config="false"
					disable-url-rewriting="true" 
					create-session="stateless" 
					entry-point-ref="unauthorizedEntryPoint"
					authentication-manager-ref="authenticationManager">
					
		<!-- Custom Filters -->			
		<security:custom-filter ref="authenticationTokenProcessingFilter" position="FORM_LOGIN_FILTER" />
<!-- 	<security:custom-filter ref="csrfHeaderFilter" after="CSRF_FILTER" /> -->
		<security:custom-filter ref="exceptionHandlerFilter" position="FIRST" />

		<!-- Access Rights -->
		<!-- ===================================================================================================================================== -->
		<!-- Unauthenticated access -->
		<security:intercept-url 				pattern="/rest/users/noAuth/**" 							access="permitAll()" />
		<security:intercept-url 				pattern="/rest/common/users/noAuth/**" 						access="permitAll()" />
		<security:intercept-url method="GET" 	pattern="/rest/translation/fe/noAuth/**" 					access="permitAll()" />
		<security:intercept-url 				pattern="/rest/usersMobile/noAuth/**" 						access="permitAll()" />
		<security:intercept-url 				pattern="/rest/admin/home/pin/**" 						access="permitAll()" />
	
		
		<!-- Authenticated - AnyRole requests -->																		
		<security:intercept-url 				pattern="/rest/users/**" 									access="isAuthenticated()" />
		<security:intercept-url 				pattern="/rest/common/users/**" 							access="isAuthenticated()" />
		<security:intercept-url method="GET" 	pattern="/rest/translation/fe/**" 							access="isAuthenticated()" />
		<security:intercept-url method="GET" 	pattern="/rest/translation/languages/**" 					access="isAuthenticated()" />
		<security:intercept-url method="GET" 	pattern="/rest/reports/populateDropdownParameter" 			access="isAuthenticated()" />


		<security:intercept-url method="PUT"	pattern="/rest/risks/**"	 								access="isAuthenticated()" />
		<security:intercept-url method="POST"	pattern="/rest/risks/**"	 								access="isAuthenticated()" />		
		<security:intercept-url 				pattern="/rest/usersMobile/**" 								access="hasAnyRole('ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		
		<!-- Role_Admin level -->
		<security:intercept-url method="GET" 	pattern="/rest/admin/users/filtered"						access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/users/role" 							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		

		<security:intercept-url method="POST" 	pattern="/rest/admin/users"		 							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		

		<security:intercept-url method="PUT" 	pattern="/rest/admin/users/enable" 							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A')" />
		<security:intercept-url method="PUT" 	pattern="/rest/admin/users" 								access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A')" />
																										
																										
		<!-- Kjgri user managment -->																									
		<security:intercept-url method="GET" 	pattern="/rest/kjgriAdmin/users/filtered"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_ADMIN_I', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/kjgriAdmin/users/role/**" 					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/kjgriAdmin/users/client/role" 				access="hasAnyRole('ROLE_ADMIN_I', 'ROLE_ADMIN_A', 'ROLE_SUBADMIN_I', 'ROLE_SUBADMIN_A')" />
		<security:intercept-url method="POST" 	pattern="/rest/kjgriAdmin/users"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A')" />	 	
		<security:intercept-url method="PUT" 	pattern="/rest/kjgriAdmin/users/enable/**" 					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A')" />
		<security:intercept-url method="PUT" 	pattern="/rest/kjgriAdmin/users" 							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I', 'ROLE_ADMIN_A')" />


	
		<!-- KJGRI ACTIONS AND TEMPLATES  -->
		<security:intercept-url method="POST" 	pattern="/rest/kjgri/admin/actions/checked"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		<security:intercept-url method="GET" 	pattern="/rest/kjgri/admin/actions/checked"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		<security:intercept-url 			 	pattern="/rest/client/locations/**"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />

		<security:intercept-url method="GET" 	pattern="/rest/admin/companies/locations"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		<security:intercept-url 			 	pattern="/rest/admin/risks/actions"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		
		<!-- KJGRI HOME PAGE  -->
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/clientCompanies"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/clientLocations"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/locations"						access="hasAnyRole('ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		<security:intercept-url method="GET" 	pattern="/rest/client/risks/subrisks/**"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/history"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/measureType"						access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A')" />
		
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/companyLocations"					access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		
		<security:intercept-url method="GET" 	pattern="/rest/admin/home"									access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/geolocations"						access="hasAnyRole('ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A', 'ROLE_SUPER_ADMIN')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/client/locations"					access="hasAnyRole('ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I', 'ROLE_SUPER_ADMIN')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/geolocationHistory"				access="hasAnyRole('ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A', 'ROLE_SUPER_ADMIN')" />
		<security:intercept-url method="GET" 	pattern="/rest/admin/home/minMax"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		

		
		<!-- HISTORY PAGE -->
		<security:intercept-url 				pattern="/rest/history/clients/styles"						access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A','ROLE_GOLD_A', 'ROLE_SILVER_A', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		<security:intercept-url 				pattern="/rest/history/clients/**"							access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_PLATINUM_I', 'ROLE_GOLD_I', 'ROLE_SILVER_I')" />
		
	
		<!-- Join -->
		<security:intercept-url 			 	pattern="/rest/admin/companies/join"						access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN_I')" />
		<security:intercept-url 			 	pattern="/rest/admin/companies/insurance/clientCompanies"	access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
		<security:intercept-url 			 	pattern="/rest/admin/companies/insurance/clientCompanies/**"	access="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_PLATINUM_A', 'ROLE_GOLD_A', 'ROLE_SILVER_A')" />
														 												
		<!-- Role_Super_Admin level -->
		<security:intercept-url pattern="/rest/**" access="hasAnyRole('ROLE_SUPER_ADMIN')" />
		<!-- ===================================================================================================================================== -->

		<!-- CSRF settings -->
		<!-- <security:csrf token-repository-ref="csrfTokenRepository" /> -->			
		 <security:csrf disabled="true"/>
		 
		 <!-- Access denied handler -->
		 <security:access-denied-handler ref="accessDeniedHandler" />
	</security:http>
	
	 <!-- Security Beans -->
	<bean name="kjcUserAccountsDao" class="com.kirey.kjcore.data.dao.KjcUserAccountsDao"/>
	<bean id="authenticationTokenProcessingFilter" class="com.kirey.kjcore.features.security.AuthenticationTokenProcessingFilter" />
	<bean id="exceptionHandlerFilter" class="com.kirey.kjcore.features.security.ExceptionHandlerFilter" />
	<bean id="unauthorizedEntryPoint" class="com.kirey.kjcore.features.security.UnauthorizedEntryPoint" />
	<bean id="accessDeniedHandler"  class="com.kirey.kjcore.features.security.AccessDeniedExceptionHandler"/>
	<bean id="encoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder">
		<constructor-arg name="strength" value="11" />
  	</bean>
	
	<!--<bean id="csrfHeaderFilter" class="it.kirey.kfuture.security.CsrfHeaderFilter"/>
	<bean id="csrfTokenRepository" class="org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository">
		<property name="headerName" value="X-XSRF-TOKEN"/>
	</bean> -->
</beans>
