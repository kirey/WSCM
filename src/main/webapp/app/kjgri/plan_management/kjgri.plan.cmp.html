<div id="cmp-plan_management" class="app_content-container-cmp">
    <div *ngIf="componentAlert.show" class="alert_box">
        <alert [type]="componentAlert.type" [dismissible]="componentAlert.dismissible" (close)="this._utilityService.setAlert(this.componentAlert)">
            <span [innerHTML]="componentAlert.message"></span>
        </alert>
    </div>

    <h2 class="view-header">
        <div class="view-header-sub">
            {{'fe.planManagement.mainHeader' | translate}}
        </div>
    </h2>

    <div class="container-fluid">
        <div class="row"> 
            <div class="col-md-12 padding-bottom-20">
                <lazyload-dropdown [inline]="true" [label]="'fe.planManagement.location' | translate" [(ngModel)]="selectedLocation" (ngModelChange)="onLocationChange()" [value]="locations" [placeholder]="'fe.generalComponentContent.select' | translate"
                    [filterPlaceholder]="'fe.generalComponentContent.search' | translate" display="name"></lazyload-dropdown>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12" *ngIf="selectedLocation && risks">
                <p-accordion *ngIf="placeholders">
                    <p-accordionTab #tab>
                        <p-header>
                            <h3 class="margin-top-10">{{ 'fe.planManagement.placeholdersHeader' | translate }}</h3>
                        </p-header>
                        <form name="placeholderForm">
                            <div *ngFor="let placeholder of placeholders" class="form-group">
                                <label for="{{ placeholder.code }}">{{ ('fe.planManagement.'+placeholder.code) | translate }}</label>
                                <textarea class="form-control" [(ngModel)]="placeholder.templateText" placeholder="{{ ('fe.planManagement.'+placeholder.code) | translate }}" [ngModelOptions]="{standalone: true}"></textarea>
                            </div>
                        </form>
                    </p-accordionTab>
                </p-accordion>

                <!-- Spacer -->
                <div class="padding-bottom-20"></div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="pull-left margin-top-10">{{'fe.planManagement.chosenActions' | translate}}</h3>
                        <div class="pull-right">
                            <button [disabled]="!(selectedLocation && risks)" class="btn btn-primary" (click)="showModal(listActionsModal)">Action Questionnaire</button>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div class="panel-body">
                        <div *ngIf="isRiskListEmpty">
                            <p class="text-muted">No actions selected.</p>
                        </div>
                        <div *ngFor="let risk of riskListCopy; let riskKey = index;">
                            <div *ngFor="let subrisk of risk.dicRiskSubtypeses; let subriskKey = index;" class="row">
                                <h4 class="padding-left-10 margin-bottom-0" *ngIf="subrisk.actionses && subrisk.actionses.length>0">{{ subrisk.name }}</h4>
                                <hr class="margin-top-0 bigger" *ngIf="subrisk.actionses && subrisk.actionses.length>0">
                                <div class="col-md-12">
                                    <div *ngFor="let action of subrisk.actionses; let actionKey = index;" class="padding-bottom-15">
                                        <div class="col-md-11">
                                            <h5><strong>{{ action?.name }}</strong></h5>
                                            <p>{{ action?.description }}</p>
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-warning" (click)="showModal(actionModal, 'editAction', {action:action,subrisk:subrisk})">
                                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                            </button>
                                            <button type="button" class="btn btn-danger" (click)="showModal(deleteAction, 'deleteAction', action, riskKey, subriskKey)">
                                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                            </button>
                                        </div>
                                        <hr class="margin-top-10 margin-bottom-0 smaller">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <button [disabled]="!selectedLocation" type="button" class="btn btn-default" (click)="archivePlan()">Archive</button>
                <button [disabled]="!selectedLocation" type="button" class="btn btn-success" (click)="savePlan()">
                    {{ 'fe.generalComponentContent.save' | translate }}
                </button>
                <button [disabled]="!selectedLocation" *ifBrowser="['Chrome', 'Firefox']" type="button" class="btn btn-primary" (click)="previewPlan()">
                    {{ 'fe.planManagement.saveAndOpen' | translate }}
                </button>
            </div>
        </div>
    </div>

    <!-- Actions Modal -->
    <div bsModal #listActionsModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="listActionsModal" aria-hidden="true">
        <div *ngIf="selectedLocation && risks" class="modal-dialog modal-lg modal-dialog-center">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" aria-label="Close" (click)="hideModal(listActionsModal)">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                    <h4 class="modal-title">{{ 'fe.generalComponentContent.select' | translate }}</h4>
                </div>
                <div class="modal-body clearfix">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12" *ngFor="let risk of risks; let riskKey = index;">
                                <p-accordion [multiple]="true">
                                    <p-accordionTab *ngFor="let subrisk of risk.dicRiskSubtypeses; let subriskKey = index;">
                                        <p-header [innerHTML]='drawSubriskAlert(riskKey, subriskKey, subrisk) | safeHtml'>
                                            
                                        </p-header>
                                        <div *ngIf="subrisk?.actionses && subrisk?.actionses.length>0">
                                            <div *ngFor="let action of subrisk.actionses; let actionKey = index;" class="row">
                                                <div class="col-md-12">
                                                    <p-checkbox [value]="action" label="{{ action?.name }}" [(ngModel)]="riskList[riskKey].dicRiskSubtypeses[subriskKey].actionses" (onChange)="addOrRemoveAction($event, action, riskKey, subriskKey)"></p-checkbox>
                                                </div>
                                            </div>
                                        </div>
                                        <div *ngIf="!(subrisk?.actionses.length>0)">
                                            <p class="text-muted">No records found.</p>
                                        </div>
                                    </p-accordionTab>
                                    <div *ngIf="!(risk.dicRiskSubtypeses.length>0)">
                                        <p class="text-muted">No records found.</p>
                                    </div>
                                </p-accordion>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" (click)="hideModal(listActionsModal)">{{'fe.generalComponentContent.close' | translate}}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Action Modal -->
    <div bsModal #actionModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="actionModal" aria-hidden="true">
        <div *ngIf="actionModalForm" class="modal-dialog modal-lg modal-dialog-center">
            <div class="modal-content">
                <form [formGroup]="actionModalForm" (ngSubmit)="saveAction(actionModal)">
                    <div class="modal-header">
                        <button type="button" class="close" aria-label="Close" (click)="hideModal(actionModal)">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        </button>
                        <h4 class="modal-title">{{ 'fe.planManagement.editAction' | translate }}</h4>
                    </div>
                    <div class="modal-body clearfix">
                        <div class="form-group">
                            <label for="name">{{ 'fe.planManagement.subriskName' | translate }}:</label> {{ actionModalForm.controls.dicRiskSubtypes.value?.name }}
                        </div>
                        <div class="form-group">
                            <label for="subrisk.name">{{ 'fe.planManagement.labelActionName' | translate }}:</label> {{ actionModalForm.controls.name.value }}
                        </div>
                        <div class="form-group">
                            <label for="description">{{ 'fe.generalComponentContent.description' | translate }}</label>
                            <control-messages [control]="actionModalForm.controls.description"></control-messages>
                            <textarea class="form-control" formControlName="description" placeholder="{{ 'fe.generalComponentContent.description' | translate }}" rows="25"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" (click)="hideModal(actionModal)">{{'fe.generalComponentContent.cancel' | translate}}</button>
                        <button type="submit" class="btn btn-success" [disabled]="actionModalForm.invalid">{{'fe.generalComponentContent.save' | translate}}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Action Modal -->
    <div bsModal #deleteAction="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="deleteAction" aria-hidden="true">
        <div *ngIf="actionToDelete" class="modal-dialog modal-lg modal-dialog-center">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" aria-label="Close" (click)="hideModal(deleteAction)">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                    <h4 class="modal-title">{{ 'fe.generalComponentContent.remove' | translate}}</h4>
                </div>
                <div class="modal-body clearfix">
                    <p>Are you sure you want to remove this item?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" (click)="hideModal(deleteAction)">{{'fe.generalComponentContent.cancel' | translate}}</button>
                    <button type="button" class="btn btn-success" (click)="removeAction(deleteAction)">{{'fe.generalComponentContent.remove' | translate}}</button>
                </div>
            </div>
        </div>
    </div>
</div>